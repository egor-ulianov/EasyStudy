{% include 'header.html' %}
    <!-- Our application root element -->
    <script src="../static/tinymce/tinymce.min.js" referrerpolicy="origin"></script>
    <div id="app">
      <b-container align-h="center" fluid>
        <b-jumbotron header-level="4" header="{{plugin_name}} Create" lead="Create user study.">
            Specify value of K (recommendation length) and prolific code (if needed).
        </b-jumbotron>
          <b-row align-h="center" class="mb-3">
            <b-col cols="8">
              <label for="k">Please select a value of K (recommendation length)</label>
              <b-form-input v-model="kValue" type="range" min="1" max="20"></b-form-input>
              <div class="mb-2">Value: [[ kValue ]]</div>
            </b-col>
          </b-row>
          <b-row align-h="center" class="mb-3">
            <b-col cols="8">
              <b-input type="text" id="prolific_code" v-model="prolificCode" name="prolific_code" placeholder="Please enter prolific code (if needed)"/>
            </b-col>
          </b-row>
          
          <b-row align-h="center" class="mb-3">
            <b-col cols="8">
              <label for="k">Please select a refinement layout</label>
              <b-form-select v-model="refinementLayout" :options="refinementLayoutOptions" required="True" type=""/>
            </b-col>
          </b-row>

          <b-row align-h="center" class="mb-3">
            <b-col class="text-center" cols="8">
              <b-form-checkbox v-model="disableRelativeComparison">{{disable_relative_comparison}}</b-form-checkbox>
            </b-col>
          </b-row>
          <b-row align-h="center" class="mb-3">
            <b-col class="text-center" cols="8">
              <b-form-checkbox v-model="disableDemographics">{{disable_demographics}}</b-form-checkbox>
            </b-col>
          </b-row>
          <b-row align-h="center" class="mb-3">
            <b-col class="text-center" cols="8">
              <b-form-checkbox v-model="separateTrainingData">{{separate_training_data}}</b-form-checkbox>
            </b-col>
          </b-row>

          <b-row align-h="center" class="mb-3">
            <b-col class="text-center" cols="8">
              <b-form-checkbox v-model="overrideAbout">{{override_about}}</b-form-checkbox>
            </b-col>
          </b-row>
          <b-row :hidden="!overrideAbout" align-h="center" class="mb-3">
            <b-col cols="8">
              <textarea placeholder="{{about_placeholder}}" id="about"></textarea>
            </b-col>
          </b-row>
          <b-row align-h="center" class="mb-3">
            <b-col class="text-center" cols="8">
              <b-form-checkbox v-model="overrideComparisonHint">{{override_algorithm_comparison_hint}}</b-form-checkbox>
            </b-col>
          </b-row>
          <b-row :hidden="!overrideComparisonHint" align-h="center" class="mb-3">
            <b-col cols="8">
              <textarea placeholder="{{algorithm_comparison_placeholder}}" id="comparisonHint"></textarea>
            </b-col>
          </b-row>
          <b-row align-h="center">
            <b-col cols="8" class="text-right" align-h="end">
              <b-btn variant="warning" v-on:click="cancelCreateUserStudy">Cancel</b-btn>
              <b-btn variant="primary" v-on:click="onCreateUserStudy">Create</b-btn>
            </b-col>
          </b-row>
      </b-container>
    </div>

    <!-- Start running your app -->
    <script>
      tinymce.init({
        selector: '#about',
        plugins: 'lists, advlist, link, image',
      });
      tinymce.init({
        selector: '#comparisonHint',
        plugins: 'lists, advlist, link, image',
      });

      window.app = new Vue({
        el: '#app',
        delimiters: ['[[',']]'], // Used to replace double { escaping with double [ escaping (to prevent jinja vs vue inference)
        data: function() {
            return {
              kValue: 10,
              overrideAbout: false,
              prolificCode: "",
              overrideComparisonHint: false,
              disableRelativeComparison: false,
              disableDemographics: false,
              separateTrainingData: false,
              refinementLayoutOptions: [
                { value: "", text: "Random" },
                { value: "default", text: "Default" },
                { value: "default_shifted", text: "Default Shifted" },
                { value: "buttons", text: "Buttons" },
                { value: "options", text: "Options" },
              ],
              refinementLayout: ""
            }
        },
        methods: {
          prepareOverrides() {
              let textOverrides = {};
              if (this.overrideComparisonHint) {
                textOverrides["comparison_hint"] = tinymce.get("comparisonHint").getContent();
              }
              if (this.overrideAbout) {
                textOverrides["about"] = tinymce.get("about").getContent();
              }
              return textOverrides;
            },
            async onCreateUserStudy() {
                let pluginName = "{{plugin_name}}";
                console.log("Creating user study for plugin: " + pluginName);
                
                let textOverrides = this.prepareOverrides();

                let userStudyConfiguration = {
                    "k": parseInt(this.kValue),
                    "prolific_code": this.prolificCode,
                    "refinement_layout": this.refinementLayout,
                    "text_overrides": textOverrides,
                    "disable_relative_comparison": this.disableRelativeComparison,
                    "disable_demographics": this.disableDemographics,
                    "separate_training_data": this.separateTrainingData
                };

                let userStudyData = {
                    "parent_plugin": pluginName,
                    "config": userStudyConfiguration
                };

                let res = await fetch("/create-user-study",
                    {
                        method: "POST",
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token() }}'
                        },
                        body: JSON.stringify(userStudyData),
                        redirect: "follow"
                    }
                ).then(response => {
                    if (response.redirected) {
                        console.log(response);
                        window.location.href = response.url;
                    } else {
                        return response.text()
                    }
                });
                console.log(res);
            },
            
            cancelCreateUserStudy() {
                window.location.href = "{{ url_for('main.administration') }}"
            }
        }
      })
    </script>
{% include 'footer.html' %}